package hwcontrol;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.InetSocketAddress;
import java.net.SocketException;
import java.net.SocketTimeoutException;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Arrays;

import com.google.gson.Gson;

public class HGW2000Controller {

	public HGW2000Controller() {

		init();

	}

	private Configuration configuration;

	private String hostName;
	private int port;

	private String errorMessage;

	public String viewLog() throws IOException {

		return loadStringFromFile("/home/hi/honeywell.log");

	}

	public String getLastErrorMessage() {
		return errorMessage;
	}

	public Configuration viewCurrentConfiguration() {
		return configuration;
	}

	public void init() {

		try {
			this.loadConfiguration();

		} catch (Exception e) {

			if (e.getMessage() != null) {
				this.errorMessage = e.getMessage();
			}

			if (e.getCause() != null) {
				this.errorMessage += ", caused by: "
						+ e.getCause().getMessage();
			}

		}
	}

	protected void ensureState() throws UnsupportedEncodingException, IOException {

		if (configuration == null) {

			return;
		}

		if (this.token == null) {
			// move out code from here to ensure connect every time

		}
		try {
			this.connectToGateway(configuration.getUsername(),
					configuration.getPassword(),
					configuration.getHostIPAddress(), configuration.getPort(),
					true);
		} catch (NoSuchAlgorithmException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}

	}

	public String CONFIG_PATH = "conf/hgw2000.json";

	protected void loadConfiguration() throws IOException {
		File configFile = new File(CONFIG_PATH);

		if (!configFile.exists()) {
			logln("File: " + CONFIG_PATH
					+ " does not exist yet, please connect to hgw host first");
			return;
		}

		String configurationText = loadStringFromFile(CONFIG_PATH);
		Gson gson = new Gson();
		this.configuration = gson.fromJson(configurationText,
				Configuration.class);

	}

	protected void saveCurrentConfiguration() throws IOException {
		if (this.configuration == null) {
			throw new IllegalStateException(
					"Can not save the configuration, current configuration is not load or configured yet");
		}
		Gson gson = new Gson();
		String content = gson.toJson(this.configuration);
		saveStringToFile(content, CONFIG_PATH);

	}

	public void saveConfiguration(String username, String password,
			String hostname, int port) throws IOException {
		if (this.configuration == null) {

			this.configuration = new Configuration();

			// throw new
			// IllegalStateException("Can not save the configuration, current configuration is not load or configured yet");
		}

		this.configuration.setUsername(username);
		this.configuration.setPassword(password);
		this.configuration.setHostIPAddress(hostname);
		this.configuration.setPort(port);

		Gson gson = new Gson();
		String content = gson.toJson(this.configuration);
		saveStringToFile(content, CONFIG_PATH);

	}

	protected void saveStringToFile(String content, String fileName)
			throws IOException {

		BufferedWriter outBuffer = new BufferedWriter(new FileWriter(fileName));
		outBuffer.write(content);
		outBuffer.close();

	}

	protected String loadStringFromFile(String fileName) throws IOException {

		StringBuffer stringBuffer = new StringBuffer();

		BufferedReader in = new BufferedReader(new FileReader(fileName));
		String str;
		while ((str = in.readLine()) != null) {
			stringBuffer.append(str);
			stringBuffer.append(newLine());
		}
		in.close();

		return stringBuffer.toString();

	}

	protected String newLine() {
		return "\r\n";
	}

	InetSocketAddress gatewayAddress;
	private DatagramSocket clientSocket;

	public String getHostName() {
		return hostName;
	}

	public void setHostName(String hostName) {
		this.hostName = hostName;
	}

	public int getPort() {
		return port;
	}

	public void setPort(int port) {
		this.port = port;
	}

	public String getToken() {
		return token;
	}

	public void setToken(String token) {
		this.token = token;
	}

	public void connectToGateway(String username, String password,
			String hostname, int port, boolean saveConfig)
			throws NoSuchAlgorithmException, UnsupportedEncodingException,
			IOException {

		gatewayAddress = new InetSocketAddress(hostname, port);
		String response = executeCommand("$verify," + username + ","
				+ this.getKeyedDigest(password) + "\n");

		String commands[] = response.split(",");
		int length = commands.length;
		if (length < 2) {
			throw new IllegalStateException(response
					+ " is not contains the right parameters");
		}

		if (!"$verify".equals(commands[0])) {
			throw new IllegalStateException(response + " is not as expected");
		}
		if ("error".equals(commands[1])) {
			throw new IllegalStateException(response
					+ " is not as expected, authentication failed!");
		}
		logln("New token: " + commands[1].trim());
		this.setToken(commands[1].trim());

		if (saveConfig) {
			saveConfiguration(username, password, hostname, port);
		}

	}

	public void connectToGateway(String username, String password,
			String hostname, int port) throws NoSuchAlgorithmException,
			UnsupportedEncodingException, IOException {

		connectToGateway(username, password, hostname, port, false);

	}

	private void logln(String message) {

		System.out.println(message);
	}

	private void log(String message) {

		System.out.print(message);
	}

	/*
	 * 
	 * 4.1.1 1711771701751711771711771717 17117717017517117717117717170171171177171177 cfg/ack/req/res 171177171177171177171177,1711771711771711771711711711771711771701761701701711771701791711771701751711771711771717,171177171177170179171177171177171177171177171177170171171177171177 Maia II 171177170175177173 ?
	 * 171177171177171177171177171177171177171177171177 cfg 171177171177171177171177171177170174171177171177171177171177: token$cfg,lig,id,action,on/off,dimmer,0\n ack 171177171177171177171177171177170174171177171177171177171177:
	 * token$ack,lig,id,action,on/off,dimmer,err 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177: id: 17117717017517117717117717171177171177 id
	 * 171177171177,17117717117717017317017117117717117717117717117717117717141177171177; action: 4 170172171177171177171177170171171177171177171177,5 170172171177171177170173170171171177171177171177170301751711771711771717,6 170172171177171179171177170173170171171177171177171177170301751711771711771717; on/off: 171177171177171177171170171177171177171177,0
	 * 170172171177171177,1 170172171177171177;
	 * 
	 * 
	 * dimmer:171177171177171177171177171177171177171177,171177171177171177171177 Maia I 171177171177170173170171171177171177170175 128 170172171177171177171177171177171177171177171177171177,129 170172171177171177171177171177171177171177171177171177,255 170172171177171177171177171177171177 171177171177171177171177 ;171177171177171177171177 Maia II
	 * 170173170171,170173170171170171171177170176171177171177171177171177171177171177,171177171177171177171177170178171177171177171177170172171177171177171177170172 0-100 171177171177170176171177170174171177170172171177171177171177171177171177171177171177171177,0 170172 171177171177171177171177171177171177171177,100 170172171177171177171177171177171177171177170170171177; err: 171177171177171177171177170178171177 cfg
	 * 1711771711771711771711771711771711771701781701771701751711771711771717117717117717117717030177171177171177171178170173171177171177171177171177171177171177,171177171177 on/off 171177171177170172 0 171177171177170172171177171177,dimmer 171177171177171177171177171177171177171177171177, 171177171177171177171177171177171177170172 255171177171177ack 171177171177171177171177171177171177170172 cfg
	 * 171177171177171177171177170173171176171177,id171177171177action171177171177on/off171177171177dimmer 171177171177171177171177171177170175171177171177170175170175171177171177170178171177171177 ? 171177171177170179171177171177171177171177 req 171177171177171177171177171177170174171177171177171177171177:
	 * token$req,lig,id,0,0,0,0\n res 171177171177171177171177171177170174171177171177171177171177:
	 * token$res,lig,id,0,on/off,dimmer,err 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177: id: 17117717017517117717117717171177171177 id 171177171177,17117717117717017317017117117717117717117717117717117717141177171177;
	 * on/off: 171177171177171177171170171177171177171177,0 170172171177171177,1 170172171177171177; dimmer:171177171177171177171177171177171177171177,128 170172171177171177171177171177171177171177171177171177,129 170172171177171177171177171177171177171177171177171177,255 170172171177171177171177171177171177171177171177171177 ; err:
	 * 171177171177171177171177170178171177
	 */

	public ExecutionResult controlLight(int lightId, int action, int onOrOff,
			int dimmer) throws IOException {

		String requestCommand = this.construstRequest("cfg", "lig", lightId,
				lightId, onOrOff, dimmer, 0);
		// String commands[]=response.split(",");
		// int length=commands.length;
		return getResult(requestCommand);
	}

	public ExecutionResult queryLight(int lightId) throws IOException {

		String requestCommand = this.construstRequest("req", "lig", lightId, 0,
				0, 0, 0);
		// String commands[]=response.split(",");
		// int length=commands.length;
		return getResult(requestCommand);
	}

	public ExecutionResult controlHBusLight(int area, int loop, int action,
			int onOrOff, int dimmer) throws IOException {

		String requestCommand = this.construstRequest("cfg", "hbuslig", area,
				loop, action, onOrOff, dimmer, 0);
		return getResult(requestCommand);

	}

	public ExecutionResult queryHBusLight(int area, int loop)
			throws IOException {

		String requestCommand = this.construstRequest("req", "ac", area, loop,
				0, 0, 0, 0);
		return getResult(requestCommand);

	}

	/*
	 * 4.1.3.1 485 171177170173171171170171171177 485 17117717017317117117017117117717117717170171171177171177 cfg/ack171177171177req/res 171177171177171177171177171177171177171177176179171177171177171177171177 cfg/ack
	 * 17117717117717117717117117117717117717117717117717171177171177req/res 1711771711771711771711781711771701791711771717 170178170170171177171177 ?? 171177171177171177171177171177171177171177171177 cfg 171177171177171177171177171177170174171177171177171177170175171177
	 * token$cfg,ac,id,on/off,mode,fan,dir,temp_set,0,0\n ack 171177171177171177171177171177170174171177171177171177170175171177
	 * token$ack,ac, id,on/off,mode,fan,dir,temp_set,0,err\n 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177 171177170171171177
	 * id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 on/off171177171177 1711771711771711771711701711771711771711771711771711771 170172171177171177, 0 170172171177171175171177 mode171177171177 1701701701741701751711771761750 170172171177170178171177170170170174, 1 171177171177170170170174, 2
	 * 170172171177171177171177171177170170170174, 3 170172171177171177171177171177170170170174, 4 170172171177171177170175170170 170174171177171177 fan171177171177 1711771711771711771711771701751711771761750 170172171177170178171177, 1 170172171177170175171177, 2 170172171177171177171177171179171177, 3 1701721711771711771711771711791717 dir171177171177
	 * 171177171177171177171177170175171177176175171177171177171177171177171177176170 temp_set171177171177 1711771711771711771711771711771701791701721711771711771711771717171177171177 1617117717117730 170178171177174173 err171177171177 171177171177171177171177170178171177 cfg 171177171177171177171177171177171177 dir
	 * 171177171177170172171177171177171177171177171177176175170173170171171177171177170172171177171177170171171177170178171177170175171177176175171177171177170172 255 1711771711771711771717171177ack 171177171177171177171177171177171177170172 cfg 171177171177171177171177170173171177
	 * 171177171177171177171177id171177171177on/off171177171177mode171177171177fan171177171177dir171177171177temp_set 171177171177171177171177171177170175171177171177170175170175171177171177170178171177171177 ?? 171177171177170179171177171177171177171177 req 171177171177171177171177171177170174171177171177171177170175171177
	 * token$req,ac,id,0,0,0,0,0,0,0\n res 171177171177171177171177171177170174171177171177171177170175171177
	 * token$res,ac,id,on/off,mode,fan,dir,temp_set,temp_cur,err\n 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177
	 * id171177171177 171177170171171177 id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 on/off171177171177 1711771711771711771711701711771711771711771711771711771 170172171177171177, 0 170172171177171175171177 Honeywell Honeywell
	 * Shanghai R&D Center Page 19 of 26 mode171177171177 1701701701741701751711771761750 170172171177170178171177170170170174, 1 171177171177170170170174, 2 170172171177171177171177171177170170170174, 3
	 * 170172171177171177171177171177170170170174, 4 170172171177171177170175170170 170174171177171177 fan171177171177 1711771711771711771711771701751711771761750 170172171177170178171177, 1 170172171177170175171177, 2 170172171177171177171177171179171177, 3 1701721711771711771711771711791717 dir171177171177 171177171177171177171177170175171177176175171177171177171177171177171177176170
	 * temp_set171177171177 1711771711771711771711771711771701791701721711771711771711771717171177171177 1617117717117730 170178171177174173 temp_cur171177171177 1711771711771701721711771701791701721711771711771711771717171177171177 1617117717117730 170178171177174173 err171177171177 171177171177171177171177170178171177 req
	 * 171177171177171177171177171177170175171177171177170178171177171177 id 17117717017717017717017117117717117717171177171177171177171177170178170170171177171177170179171177171177res 171177171177171177171177171177171177171177171177170172 req 171177171177171177171177170173171176171177171177171177171177171177171177171177
	 * on/off171177171177mode171177171177fan171177171177dir171177171177temp_set171177171177temp_cur 171177171177171177171177170177171177170172170175171177171177171177171177171177171177 dir 171177171177171177171177 255171177171177
	 */
	public ExecutionResult controlAirCondition(int id, int onOrOff, int mode,
			int fan, int windDirection, int tempToSet) throws IOException {

		String requestCommand = this.construstRequest("cfg", "ac", id, onOrOff,
				mode, fan, windDirection, tempToSet, 0, 0);
		return getResult(requestCommand);

	}

	public ExecutionResult queryAirCondition(int id) throws IOException {

		String requestCommand = this.construstRequest("req", "ac", id, 0, 0, 0,
				0, 0, 0, 0);
		return getResult(requestCommand);

	}

	/*
	 * 4.1.3.2 171177171177171177171177170171171177 171177171177171177171177170171171177171177171177170171171177171177 cfg/ack 17117717117717117717617517117717117717017117117717017617117717117717170178170170171177170174171177170179171177171177 171177171177171177171177171177171177171177171177 cfg 171177171177171177171177171177170174171177171177171177170175171177
	 * token$cfg,ac,id,irid ,0\n ack 171177171177171177171177171177170174171177171177171177170175171177 token$ack,ac,id,irid,err\n
	 * 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177 17117717017117117717117717171177171177 id 171177171177, 17117717117717017317017117117717117717117717117717117717141177170170171177 irid171177171177 171177170171171177171177171177171177171177170170170174 id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 err171177171177
	 * 171177171177171177171177170178171177 ack 171177171177171177171177171177171177170172 cfg 171177171177171177171177170173171176171177171177171177id171177171177irid 171177171177171177170175170175170175171177171177170178
	 */

	public ExecutionResult controlInfradRedAirCondition(int id, int irid)
			throws IOException {

		String requestCommand = this.construstRequest("cfg", "ac", id, irid, 0);
		return getResult(requestCommand);

	}

	/*
	 * 
	 * 4.1.4 1711771711771701711711771717 17117717117717017117117717170171171177171177 cfg/ack171177171177req/res 171177171177171177171177171177171177171177176179171177171177171177171177 cfg/ack 17117717117717117717117117117717117717117717117717171177171177req/res
	 * 17117717117717117717117817117717017917117717170178170170171177171177 ?? 171177171177171177171177171177171177171177171177 cfg 171177171177171177171177171177170174171177171177171177170175171177 token$cfg,ufh,id,on/off,temp_set,0,0\n ack
	 * 171177171177171177171177171177170174171177171177171177170175171177 token$ack,ufh,id,on/off,temp_set,0,0\n 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177 17117717117717017117117717171177171177 id
	 * 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 on/off171177171177 1711771711771711771711701711771711771711771711771711770 1701721711771711751711771 170172171177171177171177171177 temp_set171177171177 1711771711771711771711771711771701791701721711771711771711771717171177171177 1617117717117730 170178171177174173 err171177171177
	 * 171177171177171177171177170178171177 ack 171177171177171177171177171177171177170172 cfg 171177171177171177171177170173171176171177171177171177id171177171177on/off171177171177temp_set 171177171177171177170175170175170175171177171177170178171177171177 ?? 171177171177170179171177171177171177171177 req 171177171177171177171177171177170174171177171177171177170175171177
	 * token$req,ufh,id,0,0,0,0\n Honeywell Honeywell Shanghai R&D Center Page
	 * 20 of 26 res 171177171177171177171177171177170174171177171177171177170175171177 token$res,ufh,id,on/off,temp_set,temp_cur,err\n
	 * 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177 17117717117717017117117717171177171177 id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 on/off171177171177 1711771711771711771711701711771711771711771711771711770 1701721711771711751711771 170172171177171177171177171177 temp_set171177171177
	 * 1711771711771711771711771711771701791701721711771711771711771717171177171177 1617117717117730 170178171177174173 temp_cur171177171177 1711771711771701721711771701791701721711771711771711771717171177171177 1617117717117730 170178171177174173 err171177171177 171177171177171177171177170178171177 req 171177171177171177171177171177170175171177171177170178171177171177 id
	 * 17117717017717017717117717017117117717171177171177171177171177170178170170171177171177170179171177171177res 171177171177171177171177171177171177171177171177170172 req 171177171177171177171177170173171176171177171177171177171177171177171177171177 on/off171177171177temp_set171177171177temp_cur 171177171177171177171177170177171177170172170175171177171177
	 */

	public ExecutionResult controlUFHeat(int id, int onOrOff, int tempToSet)
			throws IOException {

		String requestCommand = this.construstRequest("cfg", "ufh", id,
				onOrOff, tempToSet, 0, 0);
		return getResult(requestCommand);

	}

	public ExecutionResult queryUFHeat(int id) throws IOException {

		String requestCommand = this.construstRequest("req", "ufh", id, 0, 0,
				0, 0);
		return getResult(requestCommand);

	}

	/*
	 * 
	 * 4.1.5 171177171177171177171177 171177171177171177171177171717117717117717117717117717117717117617017817117717017317017117017117117717117717117717017017117717117717117717117717117517117717117717117717117717117717117717117717117717117717117717117717117717171717171177171177170178171177171177171717117717117717117717117717117717171177171177171177171177171177171177171177171177171717117717171177170177171177 171177171173171177171177171177171177171177170171171177171177
	 * cfg/ack171177171177req/res 171177171177171177171177171177171177171177176179171177171177171177171177 cfg/ack 171177171177171177171171171177171177170171171177171177171175171177req/res 171177171177171177171178171177170179171177171177171177171177170178170170171177171177171177171177171177171177 171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177
	 * 17117717117717117717117717117717171177171177 id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 on/off171177171177 1711771711771711771711701711771711771711771711771711770 1701721711771711751711771 170172171177171177171177171177 err171177171177 171177171177171177171177170170171177 ?? 171177171177171177171177171177171177171177171177 cfg
	 * 171177171177171177171177171177170174171177171177171177170175171177 token$cfg,relay,id,on/off,0,0,0,0\n ack 171177171177171177171177171177170174171177171177171177170175171177
	 * token$ack,relay,id,on/off,0,0,0,err\n 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177 17117717117717117717117717117717171177171177 id
	 * 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 on/off171177171177 1711771711771711771711701711771711771711771711771711770 1701721711771711751711771 170172171177171177171177171177 err171177171177 171177171177171177171177170170171177 1711771711771711771711731701771711771711771711771711771711771711771711771711771717171177171177171177170172 0
	 * 17117717117717117717117717017217117717117717117717117717117717617517117717117717117717117817117717117717^ack 171177171177171177171177171177171177170172 cfg 171177171177171177171177170173171176171177171177171177id171177171177on/off 171177171177171177170175170175170175171177171177170178171177171177 ?? 171177171177170179171177171177171177171177 req 171177171177171177171177171177170174171177171177171177170175171177
	 * token$req,relay,id,0,0,0,0,0\n res 171177171177171177171177171177170174171177171177171177170175171177
	 * token$res,relay,id,on/off,0,0,0,err\n 1711771711771701791711771711771711771711771711771717171177171177171177170172 0 17117717117717117717117717017217117717117717117717117717117717617517117717117717117717117817117717117717^req 171177171177171177171177171177170175171177171177170178171177171177
	 * id 171177170177170177171177171177171171171177171177171177170178170170171177171177 170179171177171177res 171177171177171177171177171177171177171177171177170172 req 171177171177171177171177170173171176171177171177171177171177171177171177171177 on/off 171177171177170177171177170172170175171177171177
	 */
	public ExecutionResult controlRelay(int id, int onOrOff) throws IOException {

		String requestCommand = this.construstRequest("cfg", "relay", id,
				onOrOff, 0, 0, 0, 0);
		return getResult(requestCommand);

	}

	public ExecutionResult queryRelay(int id) throws IOException {

		String requestCommand = this.construstRequest("req", "relay", id, 0, 0,
				0, 0, 0);
		return getResult(requestCommand);

	}

	/*
	 * 
	 * 4.1.6 1711771711771711771711771711771717 17117717117717117717117717117717170171171177171177 cfg/ack/req/res 1711771711771711771761751711771711771711771711711711771711771701701711771711771711771711771717117717117717117717117717017917117717117717117717117717117717017117117717017417117717117717117717117717171177171177 Honeywell
	 * Honeywell Shanghai R&D Center Page 21 of 26 ?? 171177171177171177171177171177171177171177171177 cfg 171177171177171177171177171177170174171177171177171177170175171177
	 * token$cfg,curtain,id,action,on/off,position,0\n ack 171177171177171177171177171177170174171177171177171177170175171177 token$ack,
	 * curtain,id,action,on/off,position,err\n 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177 17117717117717117717117717117717171177171177 id
	 * 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 action1711771711774 1701721711771711771711771711771711771711771711771711771711771711771711771701731711775 17017217117717117717017317017117117717117717117717021177171177171177171177171711771711776 1701721711771711791711771701731701711711771711771711771702117717117717117717117717171177171177 on/off171177171177 1711771711771711771711701711771711771711771711771711770
	 * 1701721711771711751711771 1701721711771711771711771711772 170172170175171177171177171177171177171177171177 MaiaII171177171177 position: err171177171177 171177171177171177171177170178171177 ack 171177171177171177171177171177171177170172 cfg
	 * 171177171177171177171177170173171176171177171177171177id171177171177action171177171177on/off 171177171177171177170175170175170175171177171177170178171177171177 ?? 171177171177170179171177171177171177171177 req 171177171177171177171177171177170174171177171177171177170175171177
	 * token$req,curtain,id,0,0,0,0\n res 171177171177171177171177171177170174171177171177171177170175171177
	 * token$res,curtain,id,0,on/off,position,err\n 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177 17117717117717117717117717117717171177171177 id
	 * 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 on/off171177171177 1711771711771711771711701711771711771711771711771711770 1701721711771711751711771 170172171177171177171177171177 position171177171177 err171177171177 171177171177171177171177170178171177
	 */

	public ExecutionResult controlCurtain(int id, int action, int onOrOff,
			int position) throws IOException {

		String requestCommand = this.construstRequest("cfg", "curtain", id,
				action, onOrOff, position, 0);
		return getResult(requestCommand);

	}

	public ExecutionResult queryCurtain(int id) throws IOException {

		String requestCommand = this.construstRequest("req", "curtain", id, 0,
				0, 0, 0);
		return getResult(requestCommand);

	}

	/*
	 * 4.1.7 HBUS 1711771711771711771711771711771717 17117717117717117717117717117717170171171177171177 cfg/ack/req/res 1711771711771711771761751711771711771711771711711711771711771701701711771711771711771711771717117717117717117717117717017917117717117717117717117717117717017117117717017417117717117717117717117717171177171177 ?? 171177171177171177171177171177171177171177171177
	 * cfg 171177171177171177171177171177170174171177171177171177170175171177 token$cfg,hbuscurtain,area,loop,action,on/off,position,0\n
	 * ack 171177171177171177171177171177170174171177171177171177170175171177 token$ack, hbuscurtain,area,loop,action,on/off,position,err\n
	 * 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177 17117717117717117717117717117717171177171177 id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 action1711771711774 1701721711771711771711771711771711771711771711771711771711771711771711771701731711775 17017217117717117417117717117717117717117717117717117717117717117717021177171177171177171177171711771711776
	 * 1701721711771711791711771701731701711711771711771711771702117717117717117717117717171177171177 on/off171177171177 1711771711771711771711701711771711771711771711771711770 1701721711771711751711771 1701721711771711771711771711772 170172170175 position: err171177171177 171177171177171177171177170178171177 ack 171177171177171177171177171177171177170172 cfg
	 * 171177171177171177171177170173171176171177171177171177id171177171177action171177171177on/off 171177171177171177170175170175170175171177171177170178171177171177 ?? 171177171177170179171177171177171177171177 req 171177171177171177171177171177170174171177171177171177170175171177 Honeywell Honeywell
	 * Shanghai R&D Center Page 22 of 26
	 * token$req,hbuscurtain,area,loop,0,0,0,0\n res 171177171177171177171177171177170174171177171177171177170175171177
	 * token$res,hbuscurtain,area,loop,0,on/off,position,err\n 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177
	 * 17117717117717117717117717117717171177171177 id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 on/off171177171177 1711771711771711771711701711771711771711771711771711770 1701721711771711751711771 170172171177171177171177171177 position171177171177 err171177171177 171177171177171177171177170178171177
	 */

	public ExecutionResult controlHBusCurtain(int area, int loop, int action,
			int onOrOff, int position) throws IOException {

		String requestCommand = this.construstRequest("cfg", "hbuscurtain",
				area, loop, action, onOrOff, position, 0);
		return getResult(requestCommand);

	}

	public ExecutionResult queryHBusCurtain(int area, int loop)
			throws IOException {

		String requestCommand = this.construstRequest("req", "hbuscurtain",
				area, loop, 0, 0, 0, 0);
		return getResult(requestCommand);

	}

	public ExecutionResult getResult(String requestCommand) throws IOException {
		ExecutionResult result = new ExecutionResult();
		result.setSentCommand(requestCommand);
		String response = retryCommand(requestCommand);

		result.setReceivedResponse(response);
		return result;

	}

	/*
	 * 4.1.8 1711771711771711771711771711771717 17117717117717117717117717117717170171171177171177 cfg/ack 1711771711771711771761751711771711771711771711711711771711771701761711771711771711771711771717117717117717117717117717117717117717117717117717117717171177171177170171171177170172171177170179171177171177171177176179 ?? 171177171177171177171177171177171177171177171177 cfg 171177171177171177171177171177170174171177171177171177170175171177
	 * token$cfg,ir,devid,modid,0\n ack 171177171177171177171177171177170174171177171177171177170175171177 token$ack, ir,devid,modid,err\n
	 * 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 devid171177171177 17117717117717117717117717117717171177171177 id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 modid1711771711771711771711771711771711771711771717017017017417117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 err171177171177 171177171177171177171177170178171177
	 * ack 171177171177171177171177171177171177170172 cfg 171177171177171177171177170173171176171177171177171177171177171177171177171177171177170175170175170175171177171177170178171177171177
	 */

	public ExecutionResult controlInfraRedDevice(int devid, int modid)
			throws IOException {

		String requestCommand = this.construstRequest("cfg", "ir", devid,
				modid, 0);
		return getResult(requestCommand);

	}

	/*
	 * 
	 * 4.1.9 Wifi2IR 1711771717 Wifiir 17117717170171171177171177 cfg/ack 1711771711771711771761751711771711771711771711711711771711771711771711771711771711771711761711771711771711771711771717117717117717117717117717117717117717117717117717117717171177171177170171171177170172171177170179171177171177171177176179 ?? 171177171177171177171177171177171177171177171177
	 * cfg 171177171177171177171177171177170174171177171177171177170175171177 token$cfg,wifi2ir,moduleid,keyindex,delay\n ack 171177171177171177171177171177170174171177171177171177170175171177
	 * token$ack,wifi2ir,moduleid, keyindex,err\n 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 Moduleid: wifiir
	 * 17117717171177171177170170171177171177 id Keyindex171177171177wifiir 17117717171177170174171177171177171177 index Delay: 171177171177171177170178171177171177171177171177170172170177171177171177170171171177170172171177174178170178171177171177170170171177171177 5 Err: 171177171177171177171177171177
	 */

	public ExecutionResult controlWifi2IR(int moduleid, int keyindex, int delay)
			throws IOException {

		String requestCommand = this.construstRequest("cfg", "wifi2ir",
				moduleid, keyindex, delay);
		return getResult(requestCommand);

	}

	/*
	 * 4.1.10 1711771711771711771711771711771711771711771711771711771717 171177171177171177171177171177171177171177171177170171171177171177 cfg/ack/req/res 17117717117717117717617517117717117717117717117117117717117717017617017017117717017917117717117717117717117717117717117717117717117717117717171177171177 ?? 171177171177171177171177171177171177171177171177 cfg
	 * 171177171177171177171177171177170174171177171177171177170175171177 token$cfg,music,area,status,vol,cmd,para,0\n ack 171177171177171177171177171177170174171177171177171177170175171177
	 * token$ack,music,area,status,vol,cmd,para,err 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 area171177171177
	 * 171177171177171177171177171177171177171177170172171177171177170177171177171177171177171177171177170170171177 status171177171177 1 stop, 2 play, 3 pause, -1 171177170172171177171177171177171177171177171177171177171177171177 vol171177171177 17117717117717117717117717117717117717171711771711771711771711771717
	 * 0~31171177171177-1 171177170172171177171177171177171177171177171177171177171177171177 cmd171177171177 171177171177171177171177171177171177171177171177171177171177171177171177171177176170 -1171177171177171177171177171177171177171177171177 1171177171177171177171177171177 para171177171177171177171177 para=1 171177171177170175171177171177170175171177170171171177para=0
	 * 171177171177170175171177171177170175171177171177 para171177171177 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170178171177171177171177171177(cmd 171177171177170178171177170174171177171177171177)171177171177
	 */

	public ExecutionResult controlMusic(int area, int status, int volumn,
			int command, int parameter) throws IOException {

		String requestCommand = this.construstRequest("cfg", "music", area,
				status, volumn, command, parameter, 0);
		return getResult(requestCommand);

	}

	public ExecutionResult queryMusic(int area) throws IOException {

		String requestCommand = this.construstRequest("req", "music", area, 0,
				0, 0, 0, 0, 0, 0);
		return getResult(requestCommand);

	}

	/*
	 * 4.1.11 171177171177171177171177171177171177 171177171177171177171177171177171177170171171177171177 req/res 171177171177171177176175171177171177171177171170171177171177171177171177171177170178170170171177171177170179171177171177 req 171177171177171177171177171177170174171177171177171177170175171177
	 * token$req,sensor,area,loop,sensortype,subnetid,deviceid,logicnum\n res
	 * 171177171177171177171177171177170174171177171177171177170175171177
	 * token$res,sensor,area,loop,sensortype,d1,d2,d3,d4,d5,d6,d7,d8,d9,0\n
	 * 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 area171177171177 171177171177171177171177171177171177171177171177170178171177171177171177171177171177171177170170171177 loop171177171177 1711771711771711771711771711771711771711771711771701781711771711771717171177171177 sensortype171177171177 171177171177171177171177171177171177171177171177171177171177 1 8in1
	 * DeviceType315, 2 8in1 DeviceType314, 3 12in1, 4 SensorInOne171177171177 subnetid171177171177
	 * 171177171177171177171177171177171177171177171177171177171177171177171177 ID171177171177 deviceid171177171177 1711771711771711771711771711771711771711771711771711771717 ID171177171177 logicnum171177171177 171177171177171177171177171177171177171177171177171177171178171177171177170170171177
	 * d1,d2,d3,d4,d5,d6,d7,d8,d9 171177171177 sensortype 171177171177171175171177171177171177171177170175171177 1 8in1 DeviceType315 171177170170171171171177 1
	 * 170178170170171177171177171177170170171171171177 2 17017817017017117717117701711771711771711771711771711771711771711771711771711771711771711771711771711771711770171177171177017117717117717117717017117117717017217117717117717117717011177171177171177170171171177170172171177171177171177170111771711770 3 12in1
	 * 1711771701761711771711771711771711771711771701721711771711711711771711771711771701721711771701791701721711771711771711771711771701731711771701117717117717117717117717117717017017117717011177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170170171171171177 1171177171177171177170170171171171177 21711771711770 4 SensorInOne
	 * 17117717117717017217117717017917017217117717117717117717117717017317117717011177171177171177171177171177170170171177170111771711771701751711771701721711771711771711771711771711771711771711771711771711771711771711771711771711771717171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170170171171171177 1171177171177171177170170171171171177 2 4.1.12 171177171177171177171177171177 1711771717117717117717117717117717117717061177 err
	 * 1711771711771701721711771711771711771711771701701711771711771711771711771711771711771701751711771711771701711701751711771706117717017017117717117717117717117717G171177171177171177171177171177170175171177 ?? 017117717117717117717171177171177171177171177171177171177 ?? 117117717117717117717171177171177171177171177170172171177171171171177 ?? 2171177171177
	 * 17017817017017ā0174(17117717117717117717117717117717117717117717117717117917117717117717117717117717171177171177171177179177171177171177171177171177171177170172171177170175170176171177171177171177170172171177171177)171177171177 ?? 128171177171177171177171177171177171177171177171177171177171177170172171177171171171177 Honeywell Honeywell Shanghai
	 * R&D Center Page 25 of 26 ?? 12917117717117717117717171177171177171177171177170175171177171177171177171177 ?? 130171177171177 171177171177171177177179170172171177171177 ?? 131171177171177 171177171177171177171177171177171177171177171177171177171177171177 ??
	 * 13217117717117717117717171177171177171177170175171177 ?? 133171177171177171177171177171177171179171177171177171177 ?? 13417117717117717117717171177171177171177171177
	 * 
	 * 
	 * 171177171177171177171177171177171177170171171177171177 req/res 171177171177171177176175171177171177171177171170171177171177171177171177171177170178170170171177171177170179171177171177 req 171177171177171177171177171177170174171177171177171177170175171177
	 * token$req,sensor,area,loop,sensortype,subnetid,deviceid,logicnum\n res
	 * 171177171177171177171177171177170174171177171177171177170175171177
	 * token$res,sensor,area,loop,sensortype,d1,d2,d3,d4,d5,d6,d7,d8,d9,0\n
	 */

	public ExecutionResult querySensor(int area, int loop, int sensortype,
			int subnetid, int deviceid, int logicNumber) throws IOException {

		String requestCommand = this.construstRequest("req", "sensor", area,
				loop, sensortype, subnetid, deviceid, logicNumber);
		return getResult(requestCommand);

	}

	/*
	 * 4.2.1 171177171177171177171177 1711771711771711771711771717171177171177171177171177171177171176170178171177170173170171170171171177170173171177171177171177170170170174171177171177171177171177171177171177170170170174171177170177170175177172171177171177171177171177171177171177171177170171171177170170170174171177170174171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170171171177
	 * 17117717117717017317117717117717117717117717117717017017017417117717117717017017117717117717117717117717117717117717117717117717017317017117117717117717117717117317117717117717171711771711771701741711771711771711771711771701761711771701731701711711771711771711771711771711771714117717117717117717117717117717081177171177171177 id 171177170178171177 171177171177171177171177170171171177171177 cfg/ack171177171177req/res 171177171177171177171177171177171177171177176179171177171177
	 * cfg/ack 171177171177171177171171171177171177170179171177171177171177171177171177req/res 171177171177171177171178171177170179171177171177170172171177171177171177171177(170170171177170173171177171177171177 170178171177171177170170171177171177 trigger 17117717117717117717117717117717117717117717117717117717041177170179)171177171177 ?? 171177171177171177171177171177171177171177171177 cfg
	 * 171177171177171177171177171177170174171177171177171177170175171177 token$cfg,scenario,sid,1\n ack 171177171177171177171177171177170174171177171177171177170175171177
	 * token$ack,scenario,sid,result\n 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 sid171177171177 171177171177171177171177 id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177
	 * result: 1711771711771711771701791711771711771711771711771 170172171177170176171177171177171177171177171177171177171177170175170172170172171177171179171177 cfg 171177171177171177171177171177170175170178171177171177170178171177171177 id 171177170177170175171177171177171177171177171177ack 171177171177171177171177171177171177170172 cfg 171177171177171177171177170173171176171177171177171177sid
	 * 171177171177171177170175171177171177 cfg 171177171177171177171177171177170178171177171177 result 171177171177171177170175171177171177170175171177171177171177170179171177171177171177171177 ?? 171177171177170179171177171177171177171177 req 171177171177171177171177171177170174171177171177171177170175171177
	 * token$req,scenario,areaid,1\n res 171177171177171177171177171177170174171177171177171177170175171177 token$res,scenario,sid,result\n
	 * 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 sid171177171177 171177171177171177171177 id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 areaid: 171177171177171177171177 id 17117717017017117717117717117717017317017117117717117717117717117717117717141177170170171177 result:
	 * 1711771711771711771701791711771711771711771711771 170172171177170176171177171177171177171177171177171177171177170175170172170172171177171179171177 171177171177171177171177171177171177170179171177171177171177171177171177171177171177171177171177171177171177171177170179170175171177171177171177171177171177171177170178171177170171170175171177171177171177171177171177req 171177171177171177171177171177171177 areaid 171177171177170172171177171177170178171177171177170179171177171177171177171177171177171177170170171177res
	 * 17117717117717117717117717117717061177 sid 1711771711761711771711771711771701791711771711771711771701751711771711771711771711771701701711771711771711771711771711771711771711771711771711771711771701741711771711771701781711771711771711771701021177171177171177171177171177171177171177171177171177170175170172 no171177171177
	 */

	public ExecutionResult controlScenario(int scenarioId) throws IOException {

		String requestCommand = this.construstRequest("cfg", "scenario",
				scenarioId, 1);
		return getResult(requestCommand);

	}

	public ExecutionResult queryScenario(int areaid) throws IOException {

		String requestCommand = this.construstRequest("req", "scenario",
				areaid, 0);
		return getResult(requestCommand);

	}

	/*
	 * 4.2.2 171177171177171177171177171177171177 17117717117717117717117717117717117717117717117717117717117017117717117717117717117717117717117717117717117717117717117717117717117717117717117717117117117717017317017117117717117717117717017217117717117717117717017017117717117717117713171177171177170172171177174175171177171177171177171177170178171177170175171177171177171177171177171177171177171177170179171177171177171177171177171177171177170176171177171177171177171177 171177171177170179170170171177170173171177171177171177171177171177170174171177171177 171177171177171177171177171177171177170171171177171177
	 * cfg/ack171177171177req/res 171177171177171177171177171177171177171177176179171177171177171177171177 cfg/ack 171177171177171177171171171177171177170170171177171177171177171177171177171177171177req/res 171177171177171177171178171177170179171177171177171177171177171177171177170178 170170171177171177171177171177171177171177171177171177171177171177171177171177170174171177171177 id
	 * 171177170170171177171177171177170172171177170171171177171177171177171177171177171177171177171177170174171177171177170171170175171177171177171177170177171177170176171177171177171177171177171177170178171177171177171177171177170172171177170175171177171177 017117717117799 170178171177171177171177171177171177 171177171177171177171177171177171177171177171177170172171177171177171177171177171177171177 id 171177170178171177 ?? 171177171177171177171177171177171177171177171177 cfg 171177171177171177171177171177170174171177171177171177170175171177
	 * token$cfg,trigger,id,on/off\n ack 171177171177171177171177171177170174171177171177171177170175171177 token$ack,trigger,id,result\n
	 * 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177 171177171177171177171177171177171177 id 171177170170171177 on/off: 0 1701721711771711791701701711771711771711771711771711771711771711771 170172171177171170171177171177171177171177171177171177171177 result: 1711771711771711771701791711771711771711771711771
	 * 170172171177170176171177171177171177171177171177171177171177170175170172170172171177171179171177 cfg 171177171177171177171177171177171177170170171177171177171179170170171177171177171177171177171177171177171177ack 171177171177171177171177171177171177170172 cfg 171177171177171177171177170173171176171177171177171177id 171177171177171177170175171177171177 cfg 171177171177171177171177171177170178171177171177 result
	 * 171177171177171177170175170172171177171177171177170179171177171177171177171177 ?? 171177171177170179171177171177171177171177 req 171177171177171177171177171177170174171177171177171177170175171177 token$req,trigger,id,0,0\n res 171177171177171177171177171177170174171177171177171177170175171177
	 * token$res,trigger,id,result,sid \n 171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177171177170175171177 id171177171177 171177171177171177171177171177171177 id 171177170170171177 sid171177171177 171177171177171177171177 id
	 * 171177170170171177170173170171171177171177171177171175171177 result: 1711771711771711771701791711771711771711771711771 170172171177170176171177171177171177171177171177171177171177170175170172170172171177171179171177 req 171177171177171177171177171177171177171177171177171177171177171177171177170171171177171177171177171177171177 id 171177170170171177res 171177171177171177178178171177171177 status
	 * 17117717117717117717111176171177171177171177171177171177171177171177171177171177170172170178170170171177171177171177171177 sid 17117717117717117717111176171177 171177171177170172170173170171171177171177171177171177 id 1711771701701711771711771711771711771701741711771711771701781711771717171177171177171177171177171177171177171177 id 171177171177170172 0
	 */

	public ExecutionResult controlTriger(int id, int onOrOff)
			throws IOException {

		String requestCommand = this.construstRequest("cfg", "triger", id,
				onOrOff);
		return getResult(requestCommand);

	}

	@Override
	public String toString() {
		return super.toString();
	}

	public ExecutionResult queryTriger(int id) throws IOException {

		String requestCommand = this
				.construstRequest("req", "triger", id, 0, 0);
		return getResult(requestCommand);

	}

	private Object lock = new Object();

	private String retryCommand(String command) throws IOException {
		
		synchronized (lock) {
			if(this.token==null){
				this.ensureState();
			}
			final int count = 3;
			for (int i = 0; i < count; i++) {
				try {
					
					
					String response = executeCommand(command);
					if (response.startsWith("$verify,error")) {

						logln("171177171177171177170171176174171177171177171177171173171177171177171177171177171177170174171177171177171177171177170178171177171177171177171177!");
						this.ensureState();
						continue; 
					}
					return response;

				} catch (SocketTimeoutException e) {
					logln("171177171177171177171177171177171177171177171177170172171177171177171177171177170170171177171177171177171177171177171177170178171177171177171177171177......");
					this.ensureState();
					continue;
				}

			}

			logln("171177171177171177170177170176171177171177171177171177171177171177171177 " + count + " 1711771717171177171177171177171177171177 ");
			throw new IOException("171177171177171177170177170176171177171177171177171177171177171177171177 " + count
					+ " 1711771717171177170171171177171171171177171177171177171177171177171177171177171177171177HoneyWell17117717117717117717117717117717017917117717117717117717117717117717117717117717117717117717117717017917117717117717117717117717017517117717117717061177170174171177171177");
		}

	}

	private String executeCommand(String command) throws IOException {


		String commandWithToken=this.getToken()+command;
		
		if(command.startsWith("$verify")){
			commandWithToken=command;
		}
		log("Executing command: " + commandWithToken);
		
		byte[] sendContent = commandWithToken.getBytes();
		int length = sendContent.length;

		send(this.gatewayAddress, sendContent, length);
		log("TX -> " +gatewayAddress.getHostString()+":"+gatewayAddress.getPort()+": "+ commandWithToken);

		byte[] receiveContent = receive(this.gatewayAddress);
		String response = new String(receiveContent, "UTF-8");
		log("RX <- " +gatewayAddress.getHostString()+":"+gatewayAddress.getPort()+": " + response);
		
		return response;

	}



	public DatagramSocket getSocket() throws SocketException {
		
		if (this.clientSocket == null) {
			this.clientSocket = new DatagramSocket();
		}
		if (this.clientSocket.isClosed()) {
			this.clientSocket = new DatagramSocket();
		}
		clientSocket.setSoTimeout(18000);
		//clientSocket.set
		return this.clientSocket;
		
		/*
		
		
		this.clientSocket = new DatagramSocket();
		clientSocket.setSoTimeout(6000);
		return this.clientSocket;
		
		*
		*
		*/
		

	}

	protected void send(InetSocketAddress dst, byte[] inBuffer, int len)
			throws IOException {

		DatagramSocket socket = getSocket();
		DatagramPacket request = new DatagramPacket(inBuffer, len, dst);
		socket.send(request);

	}

	protected byte[] receive(InetSocketAddress dst) throws IOException {

		DatagramSocket socket = this.clientSocket;
		byte[] inbuf = new byte[1500];
		DatagramPacket packet = new DatagramPacket(inbuf, inbuf.length, dst);
		socket.receive(packet);

		int numBytesReceived = packet.getLength();

		if (numBytesReceived <= 0) {
			// socket.close();
			throw new IllegalStateException(
					"Txpect to receive echo from the gateway");
		}

		return Arrays.copyOf(inbuf, numBytesReceived);

	}

	public String construstRequest(String command, Object... parameters) throws UnsupportedEncodingException, IOException {
		StringBuffer stringBuffer = new StringBuffer(100);
		
		//stringBuffer.append(this.token);
		stringBuffer.append("$" + command);
		for (Object o : parameters) {
			stringBuffer.append(",");
			stringBuffer.append(o) ;

		}

		stringBuffer.append("\n");
		return stringBuffer.toString();
		// this.sendCommand(command);

	}

	public VersionInfo versionInfo() throws Exception {
		VersionInfo info = new VersionInfo();
		info.setVersion("0.06");
		return info;
	}

	public String getKeyedDigest(String password)
			throws NoSuchAlgorithmException, UnsupportedEncodingException {

		if (password == null) {
			throw new IllegalArgumentException("The password can not be null");
		}
		if (password.length() == 0) {
			throw new IllegalArgumentException("The password can not be empty");
		}
		if (password.trim().length() == 0) {
			throw new IllegalArgumentException(
					"The password can not be emptry after trimed.");
		}

		byte[] utf16leBytes = password.getBytes("UTF-16LE");
		MessageDigest md5 = MessageDigest.getInstance("MD5");
		md5.update(utf16leBytes);
		byte[] digistedBytes = md5.digest();
		return toHexString(digistedBytes);

	}

	private static String toHexString(byte[] fieldData) {
		StringBuilder resultBuffer = new StringBuilder();
		for (int i = 0; i < fieldData.length; i++) {
			int v = (fieldData[i] & 0xFF);
			if (v <= 0xF) {
				resultBuffer.append("0");
			}
			resultBuffer.append(Integer.toHexString(v));
		}
		return resultBuffer.toString();
	}

	private String token;

	public void close() {

		if (this.clientSocket == null) {
			return;
		}
		this.clientSocket.close();
	}
}
